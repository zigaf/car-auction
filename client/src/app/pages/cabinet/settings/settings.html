<div class="settings">
  <h1 class="page-title">Настройки</h1>

  <!-- Profile Section -->
  <section class="settings__section">
    <h2 class="section-title">Профиль</h2>
    <div class="settings__panel">
      @if (profileLoading) {
        <div class="settings__loading">Загрузка профиля...</div>
      } @else {
        <div class="form-grid">
          <div class="form-group">
            <app-input label="Имя" type="text" placeholder="Имя" icon="person" name="firstName" [(ngModel)]="profile.firstName"></app-input>
          </div>
          <div class="form-group">
            <app-input label="Фамилия" type="text" placeholder="Фамилия" icon="person" name="lastName" [(ngModel)]="profile.lastName"></app-input>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <div class="form-input form-input--readonly">{{ profile.email }}</div>
          </div>
          <div class="form-group">
            <app-input label="Телефон" type="tel" placeholder="+380 XX XXX XXXX" icon="phone" name="phone" [(ngModel)]="profile.phone"></app-input>
          </div>
        </div>
        <div class="settings__save-row">
          <app-button type="button" variant="primary" [loading]="profileSaving" (click)="saveProfile()">
            Сохранить профиль
          </app-button>
        </div>
      }
    </div>
  </section>

  <!-- Regional Section -->
  <section class="settings__section">
    <h2 class="section-title">Региональные настройки</h2>
    <div class="settings__panel">

      @if (isRestrictedCountry) {
        <div class="restriction-notice">
          <span class="material-symbols-rounded">warning</span>
          <div>
            <strong>Ограниченный регион</strong>
            По требованию партнёра <strong>autobid.de</strong>, для пользователей из России и Республики Беларусь функционал платформы, включая пополнение баланса, может быть ограничен.
          </div>
        </div>
      }

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Страна</label>
          <div class="select-wrapper">
            <select class="form-select" [(ngModel)]="selectedCountry">
              @for (country of countries; track country.flag) {
                <option [value]="country.flag">{{ country.flag }} {{ country.name }}</option>
              }
            </select>
            <span class="material-symbols-rounded select-arrow">expand_more</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Язык</label>
          <div class="lang-selector">
            @for (lang of languages; track lang.code) {
              <button class="lang-btn" [class.lang-btn--active]="selectedLanguage === lang.code" (click)="selectedLanguage = lang.code">
                {{ lang.label }}
              </button>
            }
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Валюта</label>
          <div class="currency-selector">
            @for (cur of currencies; track cur.code) {
              <button class="currency-btn" [class.currency-btn--active]="selectedCurrency === cur.code" (click)="selectedCurrency = cur.code">
                <span class="currency-btn__symbol">{{ cur.symbol }}</span>
                {{ cur.code }}
              </button>
            }
          </div>
        </div>
      </div>
      <div class="settings__save-row">
        <app-button type="button" variant="secondary" [loading]="regionalSaving" (click)="saveRegional()">
          Сохранить региональные настройки
        </app-button>
      </div>
    </div>
  </section>

  <!-- Notifications Section -->
  <section class="settings__section">
    <h2 class="section-title">Уведомления</h2>
    <div class="settings__panel">
      <div class="notif-matrix">
        <div class="notif-matrix__header">
          <span></span>
          <span class="notif-matrix__col-label">Email</span>
          <span class="notif-matrix__col-label">Push</span>
        </div>
        @for (setting of notificationSettings; track setting.label; let i = $index) {
          <div class="notif-matrix__row">
            <span class="notif-matrix__label">{{ setting.label }}</span>
            <label class="toggle">
              <input type="checkbox" [checked]="setting.email" (change)="toggleNotification(i, 'email')" />
              <span class="toggle__track"></span>
            </label>
            <label class="toggle">
              <input type="checkbox" [checked]="setting.push" (change)="toggleNotification(i, 'push')" />
              <span class="toggle__track"></span>
            </label>
          </div>
        }
      </div>
    </div>
  </section>

  <!-- Scraper Section (Admin/Test) -->
  <section class="settings__section">
    <h2 class="section-title">BCA Парсер (тест)</h2>
    <div class="settings__panel">
      <div class="scraper">
        <p class="scraper__desc">
          Запуск парсинга автомобилей с BCA Europe. Дубли не записываются -- если лот уже есть в базе, он будет обновлён.
        </p>

        <div class="scraper__controls">
          <div class="form-group">
            <app-input label="Кол-во страниц (50 авто/стр.)" type="number" icon="layers" name="scraperMaxPages" [(ngModel)]="scraperMaxPages"></app-input>
          </div>

          <div class="scraper__buttons">
            <app-button type="button" variant="primary" [loading]="scraperLoading" (click)="startScraper()">
              <span class="material-symbols-rounded">play_arrow</span>
              Запустить парсинг
            </app-button>

            <app-button type="button" variant="secondary" (click)="checkScraperStatus()">
              <span class="material-symbols-rounded">refresh</span>
              Проверить статус
            </app-button>
          </div>
        </div>

        @if (scraperMessage) {
          <div class="scraper__result" [class.scraper__result--success]="scraperStatus === 'success'" [class.scraper__result--error]="scraperStatus === 'error'" [class.scraper__result--running]="scraperStatus === 'running'">
            <span class="material-symbols-rounded scraper__result-icon">
              {{ scraperStatus === 'success' ? 'check_circle' : scraperStatus === 'error' ? 'error' : 'hourglass_top' }}
            </span>
            <span>{{ scraperMessage }}</span>
          </div>
        }

        @if (scraperRun) {
          <div class="scraper__stats">
            <div class="scraper__stat">
              <span class="scraper__stat-value">{{ scraperRun.lotsFound }}</span>
              <span class="scraper__stat-label">Найдено</span>
            </div>
            <div class="scraper__stat">
              <span class="scraper__stat-value">{{ scraperRun.lotsCreated }}</span>
              <span class="scraper__stat-label">Создано</span>
            </div>
            <div class="scraper__stat">
              <span class="scraper__stat-value">{{ scraperRun.lotsUpdated }}</span>
              <span class="scraper__stat-label">Обновлено</span>
            </div>
            <div class="scraper__stat">
              <span class="scraper__stat-value">{{ scraperRun.imagesDownloaded }}</span>
              <span class="scraper__stat-label">Фото</span>
            </div>
            <div class="scraper__stat">
              <span class="scraper__stat-value">{{ scraperRun.pagesScraped }}/{{ scraperRun.totalPages }}</span>
              <span class="scraper__stat-label">Страниц</span>
            </div>
            <div class="scraper__stat">
              <span class="scraper__stat-value">{{ scraperRun.errorsCount }}</span>
              <span class="scraper__stat-label">Ошибок</span>
            </div>
          </div>
        }
      </div>
    </div>
  </section>
</div>
