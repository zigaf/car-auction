<div class="live">
  <!-- Loading State -->
  @if (loading) {
    <div class="live__loading">
      <span class="material-symbols-rounded spin">progress_activity</span>
      <p>Loading active auctions...</p>
    </div>
  }

  <!-- Empty State -->
  @if (!loading && auctionList.length === 0) {
    <div class="live__empty">
      <span class="material-symbols-rounded">gavel</span>
      <h3>No active auctions</h3>
      <p>There are currently no lots in live trading. Check back later.</p>
    </div>
  }

  @if (!loading && auctionList.length > 0) {
    <!-- WS disconnect banner -->
    @if (!wsConnected) {
      <div class="live__ws-banner">
        <span class="material-symbols-rounded spin">sync</span>
        <span>Reconnecting to live feed...</span>
      </div>
    }

    <!-- Stats bar -->
    <div class="live__stats">
      <div class="stat">
        <span class="stat__dot" [class.stat__dot--offline]="!wsConnected"></span>
        <span class="stat__value mono">{{ stats.activeAuctions }}</span>
        <span class="stat__label">auctions</span>
      </div>
      <div class="stat">
        <span class="material-symbols-rounded">gavel</span>
        <span class="stat__value mono">{{ stats.totalBids }}</span>
        <span class="stat__label">bids</span>
      </div>
      <div class="stat stat--ws" [class.stat--ws-on]="wsConnected" [class.stat--ws-off]="!wsConnected">
        <span class="material-symbols-rounded">{{ wsConnected ? 'wifi' : 'wifi_off' }}</span>
        <span>{{ wsConnected ? 'Live' : 'Offline' }}</span>
      </div>
    </div>

    <div class="live__columns">
      <!-- Left: Active Lot -->
      @if (activeLot) {
        <div class="live__lot">
          <!-- Car image -->
          <div class="lot__image">
            @if (getLotImage(activeLot)) {
              <img [src]="getLotImage(activeLot)" [alt]="activeLot.title" class="lot__image-img">
            } @else {
              <div class="lot__image-placeholder">
                <span class="material-symbols-rounded">directions_car</span>
              </div>
            }
            <div class="lot__image-badges">
              @if (activeLot.cosmeticGrade) {
                <span class="lot__badge lot__badge--docs">{{ activeLot.cosmeticGrade }}</span>
              }
              @if (activeLot.fuelType) {
                <span class="lot__badge lot__badge--damage">{{ activeLot.fuelType }}</span>
              }
            </div>
          </div>

          <!-- Auction ended overlay -->
          @if (auctionEnded) {
            <div class="lot__ended-banner">
              <span class="material-symbols-rounded">flag</span>
              <span>Auction ended</span>
              @if (activeLot.winnerId && isCurrentUser(activeLot.winnerId)) {
                <span class="lot__ended-won">You won!</span>
              }
            </div>
          }

          <!-- Timer + Price -->
          <div class="lot__price-row">
            <div class="lot__timer" [class]="getTimerClass(activeLot.auctionEndAt)">
              <span class="material-symbols-rounded">timer</span>
              <span class="mono">{{ getTimeLeft(activeLot.auctionEndAt) }}</span>
            </div>
            <div class="lot__current-bid">
              <span class="lot__bid-label">Current bid</span>
              <span
                class="lot__bid-value mono"
                [class.lot__bid-value--flash]="animatingBidLotId === activeLot.id"
              >{{ getCurrentPrice(activeLot) | number }} EUR</span>
            </div>
          </div>

          <!-- Lot title -->
          <h2 class="lot__title">{{ activeLot.title }}</h2>

          <!-- Specs mini grid -->
          <div class="lot__specs">
            @if (activeLot.year) {
              <div class="lot__spec">
                <span class="material-symbols-rounded">calendar_month</span>
                <span>{{ activeLot.year }}</span>
              </div>
            }
            @if (activeLot.mileage) {
              <div class="lot__spec">
                <span class="material-symbols-rounded">speed</span>
                <span>{{ activeLot.mileage | number }} km</span>
              </div>
            }
            @if (activeLot.fuelType) {
              <div class="lot__spec">
                <span class="material-symbols-rounded">local_gas_station</span>
                <span>{{ activeLot.fuelType }}</span>
              </div>
            }
            @if (activeLot.enginePowerPs) {
              <div class="lot__spec">
                <span class="material-symbols-rounded">bolt</span>
                <span>{{ activeLot.enginePowerPs }} PS</span>
              </div>
            }
            @if (activeLot.exteriorColor) {
              <div class="lot__spec">
                <span class="material-symbols-rounded">palette</span>
                <span>{{ activeLot.exteriorColor }}</span>
              </div>
            }
            @if (activeLot.saleCountry) {
              <div class="lot__spec">
                <span class="material-symbols-rounded">location_on</span>
                <span>{{ activeLot.saleCountry }}</span>
              </div>
            }
          </div>

          <!-- Bid error/success messages -->
          @if (bidError) {
            <div class="lot__message lot__message--error">
              <span class="material-symbols-rounded">error</span>
              {{ bidError }}
            </div>
          }
          @if (bidSuccess) {
            <div class="lot__message lot__message--success">
              <span class="material-symbols-rounded">check_circle</span>
              Bid placed successfully!
            </div>
          }

          <!-- Quick bid buttons -->
          @if (!auctionEnded) {
            <div class="lot__quick-bids">
              <button class="qbid" (click)="quickBid(100)">+100</button>
              <button class="qbid" (click)="quickBid(250)">+250</button>
              <button class="qbid" (click)="quickBid(500)">+500</button>
              <button class="qbid" (click)="quickBid(1000)">+1 000</button>
            </div>

            <!-- Bid input -->
            <div class="lot__bid-form">
              <div class="lot__bid-input-wrap">
                <input
                  type="number"
                  [(ngModel)]="customBidAmount"
                  [placeholder]="'Min. ' + getMinBid(activeLot)"
                  class="lot__bid-input mono"
                >
                <span class="lot__bid-currency mono">EUR</span>
              </div>
              <button class="lot__bid-btn" (click)="placeBid()" [disabled]="bidding || !wsConnected">
                <span class="material-symbols-rounded">gavel</span>
                @if (bidding) {
                  Placing...
                } @else {
                  Bid
                }
              </button>
              @if (activeLot.buyNowPrice) {
                <button class="lot__buynow-btn" (click)="buyNow()" [disabled]="!wsConnected">
                  <span class="material-symbols-rounded">bolt</span>
                  Buy Now {{ activeLot.buyNowPrice | number }}
                </button>
              }
            </div>

            <!-- Auto-bid (pre-bid) -->
            <div class="lot__prebid-form">
              <div class="lot__bid-input-wrap">
                <input
                  type="number"
                  [(ngModel)]="maxAutoBidAmount"
                  [placeholder]="'Max auto-bid from ' + getMinBid(activeLot)"
                  class="lot__bid-input mono"
                >
                <span class="lot__bid-currency mono">EUR</span>
              </div>
              <button class="lot__prebid-btn" (click)="placePreBid()" [disabled]="bidding || !wsConnected">
                <span class="material-symbols-rounded">auto_mode</span>
                Set Max Bid
              </button>
            </div>
          }

          <!-- Bid history -->
          <div class="lot__history">
            @if (bidHistory.length === 0) {
              <div class="lot__history-empty">No bids yet. Be the first!</div>
            }
            @for (bid of bidHistory; track bid.id) {
              <div class="lot__history-item">
                <span class="lot__history-flag">
                  <span class="material-symbols-rounded">person</span>
                </span>
                <span class="lot__history-bidder">{{ bid.bidderFlag || bid.user?.firstName || 'Bidder' }}</span>
                <span class="lot__history-amount mono">{{ bid.amount | number }} EUR</span>
                <span class="lot__history-time">{{ getRelativeTime(bid.createdAt) }}</span>
              </div>
            }
          </div>
        </div>
      }

      <!-- Middle: Auction List -->
      <div class="live__list" [class.live__list--show]="activeTab === 'list'">
        <div class="live__list-header">
          <h3>Auctions</h3>
          <span class="live__list-count mono">{{ auctionList.length }}</span>
        </div>
        <div class="live__list-scroll">
          @for (item of auctionList; track item.id) {
            <div class="auction-row" [class.auction-row--active]="activeLot?.id === item.id" (click)="selectLot(item)">
              <div class="auction-row__thumb">
                @if (getLotImage(item)) {
                  <img [src]="getLotImage(item)" [alt]="item.title" class="auction-row__thumb-img">
                } @else {
                  <span class="material-symbols-rounded">directions_car</span>
                }
              </div>
              <div class="auction-row__info">
                <span class="auction-row__name">{{ item.title }}</span>
                <span class="auction-row__meta">{{ item.year || '' }} · {{ (item.mileage | number) || '--' }} km · {{ item.fuelType || '' }}</span>
              </div>
              <div class="auction-row__right">
                <span
                  class="auction-row__price mono"
                  [class.auction-row__price--flash]="animatingBidLotId === item.id"
                >{{ getCurrentPrice(item) | number }}</span>
                <span class="auction-row__timer mono" [class]="getTimerClass(item.auctionEndAt)">{{ getTimeLeft(item.auctionEndAt) }}</span>
                <div class="auction-row__bottom">
                  @if (item.saleCountry) {
                    <span class="auction-row__flag">{{ item.saleCountry }}</span>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Right: Live Feed -->
      <div class="live__feed" [class.live__feed--show]="activeTab === 'feed'">
        <div class="live__feed-header">
          <h3>Live Feed</h3>
          <span class="live__feed-dot" [class.live__feed-dot--offline]="!wsConnected"></span>
        </div>
        <div class="live__feed-scroll">
          @if (liveFeed.length === 0) {
            <div class="live__feed-empty">
              <span class="material-symbols-rounded">rss_feed</span>
              <p>Waiting for bids...</p>
            </div>
          }
          @for (entry of liveFeed; track $index) {
            <div class="feed-item" [class.feed-item--new]="$index === 0">
              <span class="feed-item__bidder">{{ entry.bidderFlag }}</span>
              <span class="feed-item__car">{{ entry.lotTitle || getLotTitle(entry.lotId) }}</span>
              <span class="feed-item__increment mono accent-text">+{{ entry.amount | number }}</span>
              <span class="feed-item__time">{{ getRelativeTime(entry.timestamp) }}</span>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Mobile tabs -->
    <div class="live__mobile-tabs">
      <button [class.active]="activeTab === 'list'" (click)="activeTab = 'list'">
        <span class="material-symbols-rounded">list</span>
        Auctions
      </button>
      <button [class.active]="activeTab === 'feed'" (click)="activeTab = 'feed'">
        <span class="material-symbols-rounded">rss_feed</span>
        Live Feed
      </button>
    </div>
  }
</div>
