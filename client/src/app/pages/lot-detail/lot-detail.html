<div class="lot-detail">
  <div class="container">
    @if (loading) {
      <div class="lot-detail__loading">Загрузка...</div>
    }

    @if (!loading && !lot) {
      <div class="lot-detail__not-found">
        <span class="material-symbols-rounded">error_outline</span>
        <h2>Лот не найден</h2>
        <a routerLink="/catalog">Вернуться в каталог</a>
      </div>
    }

    @if (lot) {
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a routerLink="/">Главная</a>
        <span class="material-symbols-rounded">chevron_right</span>
        <a routerLink="/catalog">Каталог</a>
        <span class="material-symbols-rounded">chevron_right</span>
        <span>{{ lot.title }}</span>
      </nav>

      <div class="lot-detail__grid">
        <!-- Left Column -->
        <div class="lot-detail__left">
          <!-- Gallery -->
          <div class="gallery">
            <!-- Main image -->
            <div class="gallery__viewer">
              @if (currentImage) {
                <img [src]="currentImage" [alt]="lot.title" class="gallery__img" (click)="toggleFullscreen()">
              } @else {
                <div class="gallery__empty">
                  <span class="material-symbols-rounded">directions_car</span>
                  <span>Нет фото</span>
                </div>
              }

              @if (filteredImages.length > 1) {
                <button class="gallery__nav gallery__nav--prev" (click)="prevImage()">
                  <span class="material-symbols-rounded">chevron_left</span>
                </button>
                <button class="gallery__nav gallery__nav--next" (click)="nextImage()">
                  <span class="material-symbols-rounded">chevron_right</span>
                </button>
                <span class="gallery__count">{{ imageCounter }}</span>
              }
            </div>

            <!-- Tabs -->
            <div class="gallery__tabs">
              <button [class.active]="activeGalleryTab === 'all'" (click)="setGalleryTab('all')">Все фото</button>
              <button [class.active]="activeGalleryTab === 'exterior'" (click)="setGalleryTab('exterior')">Экстерьер</button>
              <button [class.active]="activeGalleryTab === 'interior'" (click)="setGalleryTab('interior')">Интерьер</button>
              <button [class.active]="activeGalleryTab === 'damage'" (click)="setGalleryTab('damage')">Повреждения</button>
            </div>

            <!-- Scrollable thumbnails -->
            @if (filteredImages.length > 0) {
              <div class="gallery__strip">
                @for (img of filteredImages; track img.url; let i = $index) {
                  <div class="gallery__thumb" [class.gallery__thumb--active]="selectedImageIndex === i" (click)="selectImage(i)">
                    <img [src]="getImageUrl(img.url)" [alt]="'Фото ' + (i + 1)">
                  </div>
                }
              </div>
            }
          </div>

          <!-- Specs -->
          <div class="specs-section">
            <h2 class="section-title">Характеристики</h2>
            @if (hasSpecs) {
              <div class="specs-grid">
                @if (lot.enginePowerPs || lot.enginePowerKw) {
                  <div class="spec-item">
                    <span class="material-symbols-rounded spec-item__icon">speed</span>
                    <div class="spec-item__content">
                      <span class="spec-item__label">Мощность</span>
                      <span class="spec-item__value">
                        @if (lot.enginePowerPs) { {{ lot.enginePowerPs }} л.с. }
                        @if (lot.enginePowerKw) { ({{ lot.enginePowerKw }} кВт) }
                      </span>
                    </div>
                  </div>
                }
                @if (lot.fuelType) {
                  <div class="spec-item">
                    <span class="material-symbols-rounded spec-item__icon">local_gas_station</span>
                    <div class="spec-item__content">
                      <span class="spec-item__label">Топливо</span>
                      <span class="spec-item__value">{{ getFuelLabel(lot.fuelType) }}</span>
                    </div>
                  </div>
                }
                @if (lot.mileage) {
                  <div class="spec-item">
                    <span class="material-symbols-rounded spec-item__icon">speed</span>
                    <div class="spec-item__content">
                      <span class="spec-item__label">Пробег</span>
                      <span class="spec-item__value">{{ lot.mileage | number }} км</span>
                    </div>
                  </div>
                }
                @if (lot.year) {
                  <div class="spec-item">
                    <span class="material-symbols-rounded spec-item__icon">calendar_month</span>
                    <div class="spec-item__content">
                      <span class="spec-item__label">Год</span>
                      <span class="spec-item__value">{{ lot.year }}</span>
                    </div>
                  </div>
                }
                @if (lot.transmission) {
                  <div class="spec-item">
                    <span class="material-symbols-rounded spec-item__icon">settings</span>
                    <div class="spec-item__content">
                      <span class="spec-item__label">КПП</span>
                      <span class="spec-item__value">{{ lot.transmission }}</span>
                    </div>
                  </div>
                }
                @if (lot.exteriorColor) {
                  <div class="spec-item">
                    <span class="material-symbols-rounded spec-item__icon">palette</span>
                    <div class="spec-item__content">
                      <span class="spec-item__label">Цвет</span>
                      <span class="spec-item__value">{{ lot.exteriorColor }}</span>
                    </div>
                  </div>
                }
                @if (lot.vehicleType) {
                  <div class="spec-item">
                    <span class="material-symbols-rounded spec-item__icon">directions_car</span>
                    <div class="spec-item__content">
                      <span class="spec-item__label">Тип</span>
                      <span class="spec-item__value">{{ lot.vehicleType }}</span>
                    </div>
                  </div>
                }
                @if (lot.numberOfOwners) {
                  <div class="spec-item">
                    <span class="material-symbols-rounded spec-item__icon">person</span>
                    <div class="spec-item__content">
                      <span class="spec-item__label">Владельцев</span>
                      <span class="spec-item__value">{{ lot.numberOfOwners }}</span>
                    </div>
                  </div>
                }
                @if (lot.numberOfKeys) {
                  <div class="spec-item">
                    <span class="material-symbols-rounded spec-item__icon">key</span>
                    <div class="spec-item__content">
                      <span class="spec-item__label">Ключей</span>
                      <span class="spec-item__value">{{ lot.numberOfKeys }}</span>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="placeholder-stub">
                <span class="material-symbols-rounded">hourglass_top</span>
                <span>Лот осматривается экспертами, информация появится позже</span>
              </div>
            }

            @if (lot.vin) {
              <div class="vin-block">
                <span class="vin-block__label">VIN:</span>
                <code class="vin-block__value mono">{{ lot.vin }}</code>
              </div>
            }
          </div>

          <!-- Equipment -->
          @if (lot.equipment && lot.equipment.length > 0) {
            <div class="info-section">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon">checklist</span>
                Комплектация
              </h2>
              <ul class="equipment-list">
                @for (item of visibleEquipment; track item) {
                  <li class="equipment-list__item">
                    <span class="material-symbols-rounded equipment-list__check">check_circle</span>
                    {{ item }}
                  </li>
                }
              </ul>
              @if (lot.equipment.length > 10) {
                <button class="show-more-btn" (click)="toggleEquipment()">
                  {{ equipmentExpanded ? 'Скрыть' : 'Показать все (' + lot.equipment.length + ')' }}
                  <span class="material-symbols-rounded">{{ equipmentExpanded ? 'expand_less' : 'expand_more' }}</span>
                </button>
              }
            </div>
          } @else {
            <div class="info-section">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon">checklist</span>
                Комплектация
              </h2>
              <div class="placeholder-stub">
                <span class="material-symbols-rounded">hourglass_top</span>
                <span>Лот осматривается экспертами, информация появится позже</span>
              </div>
            </div>
          }

          <!-- Accident Info -->
          @if (accidentInfo) {
            <div class="info-section info-section--warning">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon section-title__icon--warning">warning</span>
                Авария / Повреждения
              </h2>
              <p class="info-text">{{ accidentInfo }}</p>

              <!-- Damage photos in accident section -->
              @if (damageImages.length > 0) {
                <div class="damage-photos">
                  <h3 class="damage-photos__title">Фото повреждений</h3>
                  <div class="damage-photos__grid">
                    @for (img of damageImages; track img.url) {
                      <div class="damage-photos__item" (click)="goToImageInAllPhotos(img)">
                        <img [src]="getImageUrl(img.url)" [alt]="'Повреждение'">
                        <div class="damage-photos__overlay">
                          <span class="material-symbols-rounded">zoom_in</span>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }

          <!-- Body Condition -->
          @if (bodyCondition.length > 0) {
            <div class="info-section">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon">directions_car</span>
                Кузов
              </h2>
              <div class="condition-table">
                @for (item of bodyCondition; track item.part) {
                  <div class="condition-row">
                    <span class="condition-row__part">{{ item.part }}</span>
                    @if (item.issues.length > 0) {
                      <div class="condition-row__issues">
                        @for (issue of item.issues; track issue) {
                          <span class="condition-tag condition-tag--damage">{{ issue }}</span>
                        }
                      </div>
                    } @else {
                      <span class="condition-tag condition-tag--ok">OK</span>
                    }
                  </div>
                }
              </div>

              <!-- Damage photos in body section (if no accident section is shown) -->
              @if (!accidentInfo && damageImages.length > 0) {
                <div class="damage-photos">
                  <h3 class="damage-photos__title">Фото повреждений</h3>
                  <div class="damage-photos__grid">
                    @for (img of damageImages; track img.url) {
                      <div class="damage-photos__item" (click)="goToImageInAllPhotos(img)">
                        <img [src]="getImageUrl(img.url)" [alt]="'Повреждение'">
                        <div class="damage-photos__overlay">
                          <span class="material-symbols-rounded">zoom_in</span>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }

          <!-- Interior Condition -->
          @if (interiorCondition.length > 0) {
            <div class="info-section">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon">airline_seat_recline_normal</span>
                Салон
              </h2>
              <div class="condition-table">
                @for (item of interiorCondition; track item.part) {
                  <div class="condition-row">
                    <span class="condition-row__part">{{ item.part }}</span>
                    @if (item.issues.length > 0) {
                      <div class="condition-row__issues">
                        @for (issue of item.issues; track issue) {
                          <span class="condition-tag condition-tag--damage">{{ issue }}</span>
                        }
                      </div>
                    } @else {
                      <span class="condition-tag condition-tag--ok">OK</span>
                    }
                  </div>
                }
              </div>
            </div>
          }

          <!-- Tires -->
          @if (tires.length > 0) {
            <div class="info-section">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon">tire_repair</span>
                Шины / Колесные диски
              </h2>
              <div class="tires-table">
                <div class="tires-table__header">
                  <span>Позиция</span>
                  <span>Глубина протектора</span>
                  <span>Размер</span>
                </div>
                @for (tire of tires; track tire.position) {
                  <div class="tires-table__row">
                    <span class="tires-table__position">{{ tire.position }}</span>
                    <span class="tires-table__depth">{{ tire.treadDepth || '-' }}</span>
                    <span class="tires-table__size">{{ tire.size || '-' }}</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Stone Chips -->
          @if (stoneChips.length > 0) {
            <div class="info-section">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon">grain</span>
                Сколы / Ветровое стекло
              </h2>
              <div class="condition-table">
                @for (item of stoneChips; track item.part) {
                  <div class="condition-row">
                    <span class="condition-row__part">{{ item.part }}</span>
                    @if (item.issues.length > 0) {
                      <div class="condition-row__issues">
                        @for (issue of item.issues; track issue) {
                          <span class="condition-tag condition-tag--damage">{{ issue }}</span>
                        }
                      </div>
                    } @else {
                      <span class="condition-tag condition-tag--ok">OK</span>
                    }
                  </div>
                }
              </div>
            </div>
          }

          <!-- Seats -->
          @if (seatsInfo) {
            <div class="info-section">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon">event_seat</span>
                Сиденья
              </h2>
              <p class="info-text">{{ seatsInfo }}</p>
            </div>
          }

          <!-- General Info -->
          @if (generalInfo) {
            <div class="info-section">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon">info</span>
                Общая информация
              </h2>
              <p class="info-text">{{ generalInfo }}</p>
            </div>
          }

          <!-- Parking Fee -->
          @if (parkingFee) {
            <div class="info-section">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon">local_parking</span>
                Стоянка
              </h2>
              <p class="info-text">{{ parkingFee }}</p>
            </div>
          }

          <!-- Condition stub when no body/interior/accident data -->
          @if (bodyCondition.length === 0 && interiorCondition.length === 0 && !accidentInfo) {
            <div class="info-section">
              <h2 class="section-title">
                <span class="material-symbols-rounded section-title__icon">fact_check</span>
                Состояние
              </h2>
              <div class="placeholder-stub">
                <span class="material-symbols-rounded">hourglass_top</span>
                <span>Лот осматривается экспертами, информация появится позже</span>
              </div>
            </div>
          }

          <!-- Status badges -->
          <div class="status-section">
            <div class="status-badges">
              @if (lot.cosmeticGrade && lot.cosmeticGrade !== '-') {
                <span class="status-badge status-badge--docs">
                  <span class="material-symbols-rounded">star</span>
                  Cosmetic: {{ lot.cosmeticGrade }}
                </span>
              }
              @if (lot.mechanicalGrade && lot.mechanicalGrade !== '-' && lot.mechanicalGrade !== 'z') {
                <span class="status-badge status-badge--condition">
                  <span class="material-symbols-rounded">build</span>
                  Mechanical: {{ lot.mechanicalGrade }}
                </span>
              }
              @if (lot.saleCountry) {
                <span class="status-badge status-badge--docs">
                  <span class="material-symbols-rounded">public</span>
                  {{ lot.saleCountry }}
                </span>
              }
            </div>
          </div>
        </div>

        <!-- Right Column: Info Panel -->
        <div class="lot-detail__right">
          <div class="auction-panel">
            <!-- Title + Favorite -->
            <div class="auction-panel__top">
              <div class="auction-panel__header">
                <h1 class="auction-panel__title">{{ lot.title }}</h1>
                @if (lot.derivative) {
                  <span class="auction-panel__trim">{{ lot.derivative }}</span>
                }
              </div>
              <button class="auction-panel__fav" [class.auction-panel__fav--active]="isFavorite" (click)="toggleFavorite()">
                <span class="material-symbols-rounded">{{ isFavorite ? 'favorite' : 'favorite_border' }}</span>
                <span class="auction-panel__fav-count">{{ favoritesCount }}</span>
              </button>
            </div>

            <!-- Starting price -->
            <div class="auction-panel__price-row">
              <div class="auction-panel__price">
                @if (lot.startingBid) {
                  <span class="auction-panel__price-label">Стартовая цена</span>
                  <span class="auction-panel__price-value mono">{{ lot.startingBid | number }} {{ lot.originalCurrency || 'EUR' }}</span>
                } @else {
                  <span class="auction-panel__price-label">Стартовая цена</span>
                  <span class="auction-panel__price-value auction-panel__price-value--pending">Ожидается</span>
                }
              </div>
            </div>

            <!-- Buy Now -->
            <div class="auction-panel__buynow">
              @if (lot.buyNowPrice) {
                <span class="auction-panel__price-label">Цена выкупа</span>
                <span class="auction-panel__price-value mono">{{ lot.buyNowPrice | number }} {{ lot.originalCurrency || 'EUR' }}</span>
              } @else {
                <span class="auction-panel__price-label">Цена выкупа</span>
                <span class="auction-panel__buynow-na">Не запрошена продавцом</span>
              }
            </div>

            <!-- Min payment -->
            @if (minPayment) {
              <div class="auction-panel__min-payment">
                <span class="material-symbols-rounded">payments</span>
                <div>
                  <span class="auction-panel__min-label">Минимальный платёж</span>
                  <span class="auction-panel__min-value mono">{{ minPayment | number }} {{ lot.originalCurrency || 'EUR' }}</span>
                </div>
              </div>
            }

            <!-- Reserve bids from partners -->
            @if (reserveBid) {
              <div class="auction-panel__reserve">
                <span class="material-symbols-rounded">groups</span>
                <div>
                  <span class="auction-panel__reserve-label">Резервная ставка партнёров</span>
                  <span class="auction-panel__reserve-value mono">{{ reserveBid | number }} {{ lot.originalCurrency || 'EUR' }}</span>
                </div>
                <p class="auction-panel__reserve-hint">Если ставки не превысят эту сумму, автомобиль уйдёт партнёрам</p>
              </div>
            }

            <!-- Info rows -->
            <div class="auction-panel__info-rows">
              @if (lot.vehicleLocation) {
                <div class="auction-panel__info-row">
                  <span class="material-symbols-rounded">location_on</span>
                  <span>{{ lot.vehicleLocation }}</span>
                </div>
              }
              @if (lot.saleLocation) {
                <div class="auction-panel__info-row">
                  <span class="material-symbols-rounded">storefront</span>
                  <span>{{ lot.saleLocation }}</span>
                </div>
              }
              @if (lot.saleDate) {
                <div class="auction-panel__info-row">
                  <span class="material-symbols-rounded">event</span>
                  <span>{{ lot.saleDate }}</span>
                </div>
              }
              @if (lot.vatTypeCode) {
                <div class="auction-panel__info-row">
                  <span class="material-symbols-rounded">receipt</span>
                  <span>VAT: {{ lot.vatTypeCode }}</span>
                </div>
              }
              @if (lot.lotNumber) {
                <div class="auction-panel__info-row">
                  <span class="material-symbols-rounded">tag</span>
                  <span>Lot #{{ lot.lotNumber }}</span>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }
  </div>
</div>

<!-- Fullscreen overlay -->
@if (fullscreenOpen && currentImage) {
  <div class="fullscreen-overlay" (click)="toggleFullscreen()">
    <div class="fullscreen-overlay__content" (click)="$event.stopPropagation()">
      <img [src]="currentImage" [alt]="lot?.title || ''" class="fullscreen-overlay__img">

      @if (filteredImages.length > 1) {
        <button class="fullscreen-overlay__arrow fullscreen-overlay__arrow--prev" (click)="prevImage()">
          <span class="material-symbols-rounded">chevron_left</span>
        </button>
        <button class="fullscreen-overlay__arrow fullscreen-overlay__arrow--next" (click)="nextImage()">
          <span class="material-symbols-rounded">chevron_right</span>
        </button>
        <span class="fullscreen-overlay__counter">{{ imageCounter }}</span>
      }

      <button class="fullscreen-overlay__close" (click)="toggleFullscreen()">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>
  </div>
}
