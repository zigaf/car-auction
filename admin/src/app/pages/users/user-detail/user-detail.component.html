<div class="page">
  <div class="page-header">
    <h1 class="page-title">–ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞</h1>
    @if (user) {
      <span class="text-muted">{{ user.email }}</span>
    }
  </div>

  @if (loading) {
    <div class="state-loading">
      <span class="material-symbols-rounded spin">progress_activity</span>
    </div>
  }

  @if (error && !loading) {
    <div class="state-error">
      <span class="material-symbols-rounded">error</span>
      {{ error }}
    </div>
  }

  @if (!loading && user) {

    @if (isRestrictedCountry) {
      <div class="restriction-banner">
        <span class="material-symbols-rounded">warning</span>
        <div class="restriction-banner__text">
          <strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–≥–∏–æ–Ω</strong>
          –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –Ω–∞—à–µ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ <strong>autobid.de</strong>, –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –†–æ—Å—Å–∏–∏ –∏ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ë–µ–ª–∞—Ä—É—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.
        </div>
      </div>
    }

    <div class="tabs">
      <button class="tab-btn" [class.tab-btn--active]="activeTab === 'info'" (click)="activeTab = 'info'">
        <span class="material-symbols-rounded">person</span> –ò–Ω—Ñ–æ
      </button>
      <button class="tab-btn" [class.tab-btn--active]="activeTab === 'balance'" (click)="openBalanceTab()">
        <span class="material-symbols-rounded">account_balance_wallet</span> –ë–∞–ª–∞–Ω—Å
      </button>
      <button class="tab-btn" [class.tab-btn--active]="activeTab === 'actions'" (click)="activeTab = 'actions'">
        <span class="material-symbols-rounded">mail</span> –î–µ–π—Å—Ç–≤–∏—è
      </button>
      <button class="tab-btn" [class.tab-btn--active]="activeTab === 'tasks'" (click)="activeTab = 'tasks'">
        <span class="material-symbols-rounded">checklist</span> –ó–∞–¥–∞—á–∏
      </button>
    </div>

    <!-- INFO TAB -->
    @if (activeTab === 'info') {
      <div class="card">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">–ò–º—è</label>
            <input class="form-control" [(ngModel)]="formFirstName" placeholder="–ò–º—è" />
          </div>
          <div class="form-group">
            <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
            <input class="form-control" [(ngModel)]="formLastName" placeholder="–§–∞–º–∏–ª–∏—è" />
          </div>
          <div class="form-group">
            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input class="form-control" [(ngModel)]="formPhone" placeholder="+7 999 000 00 00" />
          </div>
          <div class="form-group">
            <label class="form-label">–§–ª–∞–≥ —Å—Ç—Ä–∞–Ω—ã (emoji)</label>
            <input class="form-control" [(ngModel)]="formCountryFlag" placeholder="üá©üá™" maxlength="10" />
          </div>
          <div class="form-group">
            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
            <select class="form-control" [(ngModel)]="formStatus">
              @for (s of statuses; track s) {
                <option [value]="s">{{ s }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">–†–æ–ª—å</label>
            <select class="form-control" [(ngModel)]="formRole">
              @for (r of roles; track r) {
                <option [value]="r">{{ r }}</option>
              }
            </select>
          </div>
          <div class="form-group form-group--checkbox">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="formIsVerified" />
              –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
            </label>
          </div>
        </div>

        <div class="form-actions">
          <button class="btn btn--primary" [disabled]="saving" (click)="saveInfo()">
            @if (saving) {
              <span class="material-symbols-rounded spin">progress_activity</span>
            }
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
          @if (saveSuccess) {
            <span class="save-success">
              <span class="material-symbols-rounded">check_circle</span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
            </span>
          }
          @if (error && !loading) {
            <span class="save-error">{{ error }}</span>
          }
        </div>
      </div>
    }

    <!-- BALANCE TAB -->
    @if (activeTab === 'balance') {
      @if (balanceLoading) {
        <div class="state-loading">
          <span class="material-symbols-rounded spin">progress_activity</span>
        </div>
      }

      @if (!balanceLoading) {
        <!-- Balance summary -->
        <div class="balance-summary card">
          <div class="balance-summary__label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
          <div class="balance-summary__amount">‚Ç¨{{ balance ?? 0 | number: '1.2-2' }}</div>
          <button class="btn btn--secondary btn--sm" (click)="loadBalance()">
            <span class="material-symbols-rounded">refresh</span> –û–±–Ω–æ–≤–∏—Ç—å
          </button>
        </div>

        <!-- Deposit form -->
        <div class="card deposit-card">
          @if (!user.isVerified) {
            <div class="verify-gate">
              <span class="material-symbols-rounded">lock</span>
              <div>
                <strong>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</strong>
                <p>–î–µ–ø–æ–∑–∏—Ç –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–∫–ª—é—á–∏—Ç–µ ¬´–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞¬ª –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ò–Ω—Ñ–æ.</p>
              </div>
            </div>
          } @else {
            <h2 class="card-title">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</h2>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">–°—É–º–º–∞ (‚Ç¨) *</label>
                <input
                  class="form-control"
                  type="number"
                  min="1"
                  [(ngModel)]="depositAmount"
                  placeholder="500"
                />
              </div>
              <div class="form-group form-group--wide">
                <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <input
                  class="form-control"
                  [(ngModel)]="depositDescription"
                  placeholder="–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á—ë—Ç–∞"
                />
              </div>
            </div>
            <div class="form-actions">
              <button
                class="btn btn--primary btn--sm"
                [disabled]="depositSaving || !depositAmount || depositAmount <= 0"
                (click)="deposit()"
              >
                @if (depositSaving) {
                  <span class="material-symbols-rounded spin">progress_activity</span>
                } @else {
                  <span class="material-symbols-rounded">add_card</span>
                }
                –ü–æ–ø–æ–ª–Ω–∏—Ç—å
              </button>
              @if (depositSuccess) {
                <span class="save-success">
                  <span class="material-symbols-rounded">check_circle</span> –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω
                </span>
              }
              @if (depositError) {
                <span class="save-error">{{ depositError }}</span>
              }
            </div>
          }
        </div>

        <!-- Transactions -->
        <div class="card">
          <h2 class="card-title">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h2>

          @if (txLoading) {
            <div class="state-loading">
              <span class="material-symbols-rounded spin">progress_activity</span>
            </div>
          }

          @if (!txLoading && transactions.length === 0) {
            <div class="empty-state">
              <span class="material-symbols-rounded">receipt_long</span>
              <p>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ—Ç</p>
            </div>
          }

          @if (!txLoading && transactions.length > 0) {
            <div class="table-wrap">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–¢–∏–ø</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                  </tr>
                </thead>
                <tbody>
                  @for (tx of transactions; track tx.id) {
                    <tr>
                      <td class="text-muted tx-date">{{ tx.createdAt | date: 'dd.MM.yy HH:mm' }}</td>
                      <td>
                        <span class="badge" [class]="tx.amount >= 0 ? 'badge--green' : 'badge--red'">
                          {{ txTypeLabel(tx.type) }}
                        </span>
                      </td>
                      <td class="tx-amount" [class.tx-amount--positive]="tx.amount >= 0" [class.tx-amount--negative]="tx.amount < 0">
                        {{ tx.amount >= 0 ? '+' : '' }}‚Ç¨{{ tx.amount | number: '1.2-2' }}
                      </td>
                      <td class="text-muted">‚Ç¨{{ tx.balanceAfter | number: '1.2-2' }}</td>
                      <td class="text-muted tx-desc">{{ tx.description }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>

            @if (txPages() > 1) {
              <div class="pagination">
                <button class="btn btn--secondary btn--sm" [disabled]="txPage <= 1" (click)="goToPage(txPage - 1)">
                  <span class="material-symbols-rounded">chevron_left</span>
                </button>
                <span class="pagination__info">{{ txPage }} / {{ txPages() }}</span>
                <button class="btn btn--secondary btn--sm" [disabled]="txPage >= txPages()" (click)="goToPage(txPage + 1)">
                  <span class="material-symbols-rounded">chevron_right</span>
                </button>
              </div>
            }
          }
        </div>
      }
    }

    <!-- ACTIONS TAB -->
    @if (activeTab === 'actions') {
      <div class="card">
        <h2 class="card-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ</h2>
        <div class="form-group">
          <label class="form-label">–¢–µ–º–∞</label>
          <input class="form-control" [(ngModel)]="emailSubject" placeholder="–¢–µ–º–∞ –ø–∏—Å—å–º–∞" />
        </div>
        <div class="form-group">
          <label class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
          <textarea class="form-control" [(ngModel)]="emailMessage" rows="6" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞..."></textarea>
        </div>
        <div class="form-actions">
          <button
            class="btn btn--primary"
            [disabled]="emailSending || !emailSubject || !emailMessage"
            (click)="sendEmail()"
          >
            @if (emailSending) {
              <span class="material-symbols-rounded spin">progress_activity</span>
            } @else {
              <span class="material-symbols-rounded">send</span>
            }
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
          </button>
          @if (emailSent) {
            <span class="save-success">
              <span class="material-symbols-rounded">check_circle</span> –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
            </span>
          }
          @if (emailError) {
            <span class="save-error">{{ emailError }}</span>
          }
        </div>
      </div>
    }

    <!-- TASKS TAB -->
    @if (activeTab === 'tasks') {
      <app-user-tasks [userId]="userId" />
    }
  }
</div>
