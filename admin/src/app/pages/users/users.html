<div class="page">
  <div class="page-header">
    <h1 class="page-title">Пользователи</h1>
    <span class="page-count">{{ total }}</span>
  </div>

  <div class="filters">
    <input
      class="form-control filters__search"
      type="text"
      placeholder="Поиск по email, имени..."
      [(ngModel)]="filterSearch"
      (input)="onFilterChange()"
    />
    <select class="form-control filters__select" [(ngModel)]="filterRole" (change)="onFilterChange()">
      <option value="">Все роли</option>
      @for (r of roles; track r) {
        <option [value]="r">{{ roleLabels[r] }}</option>
      }
    </select>
    <select class="form-control filters__select" [(ngModel)]="filterStatus" (change)="onFilterChange()">
      <option value="">Все статусы</option>
      @for (s of statuses; track s) {
        <option [value]="s">{{ statusLabels[s] }}</option>
      }
    </select>
  </div>

  @if (error) {
    <div class="state-error">
      <span class="material-symbols-rounded">error</span>
      {{ error }}
    </div>
  }

  @if (loading) {
    <div class="state-loading">
      <span class="material-symbols-rounded spin">progress_activity</span>
    </div>
  }

  @if (!loading && !error) {
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>Пользователь</th>
            <th>Роль</th>
            <th>Статус</th>
            <th>Верификация</th>
            <th>Регистрация</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users; track user.id) {
            <tr>
              <td class="user-cell">
                <div class="user-avatar">
                  {{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}
                </div>
                <div>
                  <a class="user-name" [routerLink]="['/users', user.id]">{{ user.firstName }} {{ user.lastName }}</a>
                  <div class="text-muted" style="font-size: var(--fs-xs)">{{ user.email }}</div>
                </div>
              </td>
              <td>
                <select
                  class="status-select"
                  [value]="user.role"
                  (change)="updateRole(user, $any($event.target).value)"
                >
                  @for (r of roles; track r) {
                    <option [value]="r" [selected]="user.role === r">{{ roleLabels[r] }}</option>
                  }
                </select>
              </td>
              <td>
                <span class="badge" [class]="user.status === 'blocked' ? 'badge--red' : user.status === 'active' ? 'badge--green' : 'badge--amber'">
                  {{ statusLabels[user.status] ?? user.status }}
                </span>
              </td>
              <td>
                @if (user.documentsVerified) {
                  <span class="badge badge--green">Верифицирован</span>
                } @else {
                  <span class="badge badge--gray">Нет</span>
                }
              </td>
              <td class="text-muted">{{ user.createdAt | date:'dd.MM.yy' }}</td>
              <td>
                <button
                  class="btn btn--sm"
                  [class]="user.status === 'blocked' ? 'btn--secondary' : 'btn--danger'"
                  (click)="toggleBlock(user)"
                >
                  @if (user.status === 'blocked') {
                    <span class="material-symbols-rounded">lock_open</span>
                    Разблокировать
                  } @else {
                    <span class="material-symbols-rounded">block</span>
                    Заблокировать
                  }
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    @if (users.length === 0) {
      <div class="empty-state">
        <span class="material-symbols-rounded">group</span>
        <p>Пользователи не найдены</p>
      </div>
    }

    @if (totalPages > 1) {
      <div class="pagination">
        <button class="btn btn--secondary btn--sm" [disabled]="page === 1" (click)="prevPage()">
          <span class="material-symbols-rounded">chevron_left</span>
        </button>
        <span class="pagination__info">{{ page }} / {{ totalPages }}</span>
        <button class="btn btn--secondary btn--sm" [disabled]="page === totalPages" (click)="nextPage()">
          <span class="material-symbols-rounded">chevron_right</span>
        </button>
      </div>
    }
  }
</div>
