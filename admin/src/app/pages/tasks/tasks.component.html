<div class="page">
  <div class="page-header">
    <h1 class="page-title">Задачи</h1>
    <span class="page-count">{{ total }}</span>
  </div>

  <div class="filters">
    <select class="form-control filters__select" [(ngModel)]="filterStatus" (change)="onFilterChange()">
      <option value="">Все статусы</option>
      @for (s of statuses; track s) {
        <option [value]="s">{{ statusLabels[s] }}</option>
      }
    </select>
  </div>

  @if (error) {
    <div class="state-error">
      <span class="material-symbols-rounded">error</span>{{ error }}
    </div>
  }

  @if (loading) {
    <div class="state-loading">
      <span class="material-symbols-rounded spin">progress_activity</span>
    </div>
  }

  @if (!loading && !error) {
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>Задача</th>
            <th>Клиент</th>
            <th>Менеджер</th>
            <th>Статус</th>
            <th>Срок</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          @for (task of tasks; track task.id) {
            <tr>
              <td>
                <div class="task-title">{{ task.title }}</div>
                @if (task.description) {
                  <div class="text-muted" style="font-size: var(--fs-xs)">{{ task.description | slice:0:60 }}{{ task.description.length > 60 ? '…' : '' }}</div>
                }
              </td>
              <td>
                @if (task.targetUser) {
                  <a [routerLink]="['/users', task.targetUserId]" class="link">
                    {{ task.targetUser.firstName }} {{ task.targetUser.lastName }}
                  </a>
                } @else {
                  <span class="text-muted">—</span>
                }
              </td>
              <td class="text-muted">
                @if (task.assignedTo) {
                  {{ task.assignedTo.firstName }} {{ task.assignedTo.lastName }}
                } @else { — }
              </td>
              <td>
                <button
                  class="badge badge--clickable"
                  [class]="statusClass[task.status]"
                  (click)="cycleStatus(task)"
                  title="Нажмите, чтобы изменить"
                >
                  {{ statusLabels[task.status] }}
                </button>
              </td>
              <td class="text-muted">{{ task.dueDate ? (task.dueDate | date:'dd.MM.yy') : '—' }}</td>
              <td>
                <button class="icon-btn icon-btn--danger" (click)="deleteTask(task.id)" title="Удалить">
                  <span class="material-symbols-rounded">delete</span>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    @if (tasks.length === 0) {
      <div class="empty-state">
        <span class="material-symbols-rounded">checklist</span>
        <p>Задачи не найдены</p>
      </div>
    }

    @if (totalPages > 1) {
      <div class="pagination">
        <button class="btn btn--secondary btn--sm" [disabled]="page === 1" (click)="prevPage()">
          <span class="material-symbols-rounded">chevron_left</span>
        </button>
        <span class="pagination__info">{{ page }} / {{ totalPages }}</span>
        <button class="btn btn--secondary btn--sm" [disabled]="page === totalPages" (click)="nextPage()">
          <span class="material-symbols-rounded">chevron_right</span>
        </button>
      </div>
    }
  }
</div>
